From 99d5bdd2aff787d39db26ae854d6884a3fb9f984 Mon Sep 17 00:00:00 2001
From: jason <jason@138bc75d-0d04-0410-961f-82ee72b054a4>
Date: Tue, 17 Jun 2014 23:03:43 +0000
Subject: [PATCH 055/134] 	PR c++/60605 	* pt.c
 (check_default_tmpl_args): Check DECL_LOCAL_FUNCTION_P.

git-svn-id: svn+ssh://gcc.gnu.org/svn/gcc/branches/gcc-4_8-branch@211753 138bc75d-0d04-0410-961f-82ee72b054a4
---
 gcc/cp/ChangeLog                          | 5 +++++
 gcc/cp/pt.c                               | 3 ++-
 gcc/testsuite/g++.dg/template/local-fn1.C | 8 ++++++++
 3 files changed, 15 insertions(+), 1 deletion(-)
 create mode 100644 gcc/testsuite/g++.dg/template/local-fn1.C

diff --git a/gcc/cp/ChangeLog b/gcc/cp/ChangeLog
index f3d7c8c..c89da13 100644
--- a/gcc/cp/ChangeLog
+++ b/gcc/cp/ChangeLog
@@ -1,3 +1,8 @@
+2014-06-17  Jason Merrill  <jason@redhat.com>
+
+	PR c++/60605
+	* pt.c (check_default_tmpl_args): Check DECL_LOCAL_FUNCTION_P.
+
 2014-06-02  Jason Merrill  <jason@redhat.com>
 
 	PR c++/61134
diff --git a/gcc/cp/pt.c b/gcc/cp/pt.c
index 85b46fe..a4e1a59 100644
--- a/gcc/cp/pt.c
+++ b/gcc/cp/pt.c
@@ -4308,7 +4308,8 @@ check_default_tmpl_args (tree decl, tree parms, bool is_primary,
      in the template-parameter-list of the definition of a member of a
      class template.  */
 
-  if (TREE_CODE (CP_DECL_CONTEXT (decl)) == FUNCTION_DECL)
+  if (TREE_CODE (CP_DECL_CONTEXT (decl)) == FUNCTION_DECL
+      || (TREE_CODE (decl) == FUNCTION_DECL && DECL_LOCAL_FUNCTION_P (decl)))
     /* You can't have a function template declaration in a local
        scope, nor you can you define a member of a class template in a
        local scope.  */
diff --git a/gcc/testsuite/g++.dg/template/local-fn1.C b/gcc/testsuite/g++.dg/template/local-fn1.C
new file mode 100644
index 0000000..88acd17
--- /dev/null
+++ b/gcc/testsuite/g++.dg/template/local-fn1.C
@@ -0,0 +1,8 @@
+// PR c++/60605
+
+template <typename T = int>
+struct Foo {
+    void bar() {
+        void bug();
+    }
+};
-- 
1.8.5.5

